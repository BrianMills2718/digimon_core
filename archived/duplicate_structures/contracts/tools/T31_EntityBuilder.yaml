name: T31_EntityBuilder
version: "1.0"
description: "Builds and persists entity nodes in Neo4j graph database"

input_contract:
  type: object
  properties:
    entities:
      type: array
      minItems: 1
      items:
        type: object
        properties:
          name:
            type: string
            minLength: 1
          type:
            type: string
            minLength: 1
          confidence:
            type: number
            minimum: 0
            maximum: 1
          source_chunk_id:
            type: string
          properties:
            type: object
            description: "Ontology-validated properties"
          modifiers:
            type: object
            description: "Ontology-validated modifiers"
        required:
          - name
          - type
          - confidence
    neo4j_config:
      type: object
      properties:
        uri:
          type: string
          pattern: "^bolt://"
        database:
          type: string
          default: "neo4j"
      required:
        - uri
    deduplication_strategy:
      type: string
      enum: ["exact_match", "fuzzy_match", "semantic_similarity"]
      default: "exact_match"
  required:
    - entities

output_contract:
  type: object
  properties:
    created_entities:
      type: array
      items:
        type: object
        properties:
          entity_id:
            type: string
            pattern: "^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$"
          name:
            type: string
          type:
            type: string
          neo4j_id:
            type: integer
            description: "Neo4j internal node ID"
          merged:
            type: boolean
            description: "Whether entity was merged with existing"
          ontology_validated:
            type: boolean
            description: "Whether entity passed ontology validation"
        required:
          - entity_id
          - name
          - type
          - neo4j_id
          - merged
    summary:
      type: object
      properties:
        total_entities:
          type: integer
          minimum: 0
        created_count:
          type: integer
          minimum: 0
        merged_count:
          type: integer
          minimum: 0
        failed_count:
          type: integer
          minimum: 0
        ontology_validated_count:
          type: integer
          minimum: 0
      required:
        - total_entities
        - created_count
        - merged_count
        - failed_count
    execution_metadata:
      type: object
      properties:
        tool_name:
          type: string
          const: "T31_EntityBuilder"
        execution_time:
          type: number
          minimum: 0
        neo4j_connected:
          type: boolean
      required:
        - tool_name
        - execution_time
        - neo4j_connected
  required:
    - created_entities
    - summary
    - execution_metadata

ontology_integration:
  validate_entity_types: true
  validate_properties: true
  enrich_with_defaults: true
  allowed_entity_concepts:
    - "IndividualActor"
    - "Institution"
    - "SocialGroup"
    - "Norm"
    - "Resource"
    - "Event"
    - "Location"
    - "Document"
    - "Concept"
    - "Role"
    - "Behavior"
    - "CommunicationChannel"
    - "PowerStructure"
    - "MarketActor"
    - "InstitutionalArrangement"
    - "Organization"